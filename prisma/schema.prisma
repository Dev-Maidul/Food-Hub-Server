generator client {
  provider = "prisma-client-js"
  output = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum Role {
  CUSTOMER
  PROVIDER
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

enum OrderStatus {
  PLACED
  PREPARING
  READY
  DELIVERED
  CANCELLED
}

//////////////////////////////////////////////////////
// USER
//////////////////////////////////////////////////////

model User {
  id               String     @id @default(cuid())

  name             String?
  email            String     @unique
  password         String

  role             Role       @default(CUSTOMER)
  status           UserStatus @default(ACTIVE)

  emailVerified    Boolean    @default(false)
  verificationToken String?   @unique
  resetToken       String?    @unique
  resetTokenExpiry DateTime?

  providerProfile  ProviderProfile?
  orders           Order[]
  reviews          Review[]
  refreshTokens    RefreshToken[]

  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  @@index([role])
  @@index([status])
  @@index([createdAt])

  @@map("users")
}

//////////////////////////////////////////////////////
// PROVIDER PROFILE
//////////////////////////////////////////////////////

model ProviderProfile {
  id             String   @id @default(cuid())
  userId         String   @unique

  restaurantName String
  address        String
  phone          String
  isApproved     Boolean  @default(false)

  user    User   @relation(fields: [userId], references: [id])
  meals   Meal[]
  orders  Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isApproved])
  @@index([restaurantName])

  @@map("provider_profiles")
}

//////////////////////////////////////////////////////
// CATEGORY
//////////////////////////////////////////////////////

model Category {
  id        String  @id @default(cuid())
  name      String  @unique
  isActive  Boolean @default(true)

  meals Meal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])

  @@map("categories")
}

//////////////////////////////////////////////////////
// MEAL
//////////////////////////////////////////////////////

model Meal {
  id           String  @id @default(cuid())
  providerId   String
  categoryId   String

  name         String
  description  String
  price        Float
  image        String?
  isAvailable  Boolean @default(true)

  provider   ProviderProfile @relation(fields: [providerId], references: [id])
  category   Category        @relation(fields: [categoryId], references: [id])
  orderItems OrderItem[]
  reviews    Review[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([providerId])
  @@index([categoryId])
  @@index([isAvailable])
  @@index([price])
  @@index([createdAt])

  @@map("meals")
}

//////////////////////////////////////////////////////
// ORDER
//////////////////////////////////////////////////////

model Order {
  id              String      @id @default(cuid())
  customerId      String
  providerId      String

  status          OrderStatus @default(PLACED)
  deliveryAddress String
  totalAmount     Float

  customer User            @relation(fields: [customerId], references: [id])
  provider ProviderProfile @relation(fields: [providerId], references: [id])
  items    OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([providerId])
  @@index([status])
  @@index([createdAt])
  @@index([providerId, status]) // compound index

  @@map("orders")
}

//////////////////////////////////////////////////////
// ORDER ITEM
//////////////////////////////////////////////////////

model OrderItem {
  id        String @id @default(cuid())
  orderId   String
  mealId    String

  quantity  Int
  price     Float

  order Order @relation(fields: [orderId], references: [id])
  meal  Meal  @relation(fields: [mealId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([mealId])

  @@map("order_items")
}

//////////////////////////////////////////////////////
// REVIEW
//////////////////////////////////////////////////////

model Review {
  id         String @id @default(cuid())
  customerId String
  mealId     String

  rating     Int
  comment    String

  customer User @relation(fields: [customerId], references: [id])
  meal     Meal @relation(fields: [mealId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([mealId])
  @@index([customerId])
  @@index([createdAt])

  @@map("reviews")
}

//////////////////////////////////////////////////////
// REFRESH TOKEN (JWT ROTATION SUPPORT)
//////////////////////////////////////////////////////

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  revoked   Boolean  @default(false)

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([userId])

  @@map("refresh_tokens")
}