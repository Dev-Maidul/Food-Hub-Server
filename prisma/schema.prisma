generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum Role {
  CUSTOMER
  PROVIDER
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

enum OrderStatus {
  PLACED
  PREPARING
  READY
  DELIVERED
  CANCELLED
}

//////////////////////////////////////////////////////
// USER
//////////////////////////////////////////////////////

model User {
  id               String     @id @default(cuid()) @map("id")

  name             String?    @map("name")
  email            String     @unique @map("email")
  password         String     @map("password")

  role             Role       @default(CUSTOMER) @map("role")
  status           UserStatus @default(ACTIVE) @map("status")

  emailVerified    Boolean    @default(false) @map("email_verified")
  verificationToken String?   @unique @map("verification_token")
  resetToken       String?    @unique @map("reset_token")
  resetTokenExpiry DateTime?  @map("reset_token_expiry")

  providerProfile  ProviderProfile?
  orders           Order[]
  reviews          Review[]
  refreshTokens    RefreshToken[]

  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")

  @@index([role])
  @@index([status])
  @@index([createdAt])
  @@map("users")
}

//////////////////////////////////////////////////////
// PROVIDER PROFILE
//////////////////////////////////////////////////////

model ProviderProfile {
  id              String   @id @default(cuid()) @map("id")
  userId          String   @unique @map("user_id")

  restaurantName  String   @map("restaurant_name")
  address         String   @map("address")
  phone           String   @map("phone")
  isApproved      Boolean  @default(false) @map("is_approved")

  user    User   @relation(fields: [userId], references: [id])
  meals   Meal[]
  orders  Order[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([isApproved])
  @@index([restaurantName])
  @@map("provider_profiles")
}

//////////////////////////////////////////////////////
// CATEGORY
//////////////////////////////////////////////////////

model Category {
  id        String  @id @default(cuid()) @map("id")
  name      String  @unique @map("name")
  isActive  Boolean @default(true) @map("is_active")

  meals Meal[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([isActive])
  @@map("categories")
}

//////////////////////////////////////////////////////
// MEAL
//////////////////////////////////////////////////////

model Meal {
  id           String  @id @default(cuid()) @map("id")
  providerId   String  @map("provider_id")
  categoryId   String  @map("category_id")

  name         String  @map("name")
  description  String  @map("description")
  price        Float   @map("price")
  image        String? @map("image")
  isAvailable  Boolean @default(true) @map("is_available")

  provider   ProviderProfile @relation(fields: [providerId], references: [id])
  category   Category        @relation(fields: [categoryId], references: [id])
  orderItems OrderItem[]
  reviews    Review[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([providerId])
  @@index([categoryId])
  @@index([isAvailable])
  @@index([price])
  @@index([createdAt])
  @@map("meals")
}

//////////////////////////////////////////////////////
// ORDER
//////////////////////////////////////////////////////

model Order {
  id              String      @id @default(cuid()) @map("id")
  customerId      String      @map("customer_id")
  providerId      String      @map("provider_id")

  status          OrderStatus @default(PLACED) @map("status")
  deliveryAddress String      @map("delivery_address")
  totalAmount     Float       @map("total_amount")

  customer User            @relation(fields: [customerId], references: [id])
  provider ProviderProfile @relation(fields: [providerId], references: [id])
  items    OrderItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([customerId])
  @@index([providerId])
  @@index([status])
  @@index([createdAt])
  @@index([providerId, status]) // provider dashboard optimization
  @@map("orders")
}

//////////////////////////////////////////////////////
// ORDER ITEM
//////////////////////////////////////////////////////

model OrderItem {
  id        String @id @default(cuid()) @map("id")
  orderId   String @map("order_id")
  mealId    String @map("meal_id")

  quantity  Int    @map("quantity")
  price     Float  @map("price") // price at order time

  order Order @relation(fields: [orderId], references: [id])
  meal  Meal  @relation(fields: [mealId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([orderId])
  @@index([mealId])
  @@map("order_items")
}

//////////////////////////////////////////////////////
// REVIEW
//////////////////////////////////////////////////////

model Review {
  id         String @id @default(cuid()) @map("id")
  customerId String @map("customer_id")
  mealId     String @map("meal_id")

  rating     Int    @map("rating")
  comment    String @map("comment")

  customer User @relation(fields: [customerId], references: [id])
  meal     Meal @relation(fields: [mealId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([mealId])
  @@index([customerId])
  @@index([createdAt])
  @@map("reviews")
}

//////////////////////////////////////////////////////
// REFRESH TOKEN (JWT Rotation Support)
//////////////////////////////////////////////////////

model RefreshToken {
  id        String   @id @default(cuid()) @map("id")
  userId    String   @map("user_id")
  token     String   @unique @map("token")
  expiresAt DateTime @map("expires_at")
  revoked   Boolean  @default(false) @map("revoked")

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@map("refresh_tokens")
}